image: php:latest

stages:
  - build
  - test

cache:
  paths:
  - vendor/

composer:
  stage: build
  script:
    - apt-get update
    - apt-get install --assume-yes git zip unzip
    - export APP_ENV=testing
    - php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    - php composer-setup.php
    - php -r "unlink('composer-setup.php');"
    - php composer.phar install

phpMess:
  stage: test
  script:
    - php vendor/bin/phpmd src/ text cleancode,controversial,codesize,design,naming
  allow_failure: true

phpUnit:
  stage: test
  script:
    - php vendor/bin/phpunit --colors

phpLint:
  stage: test
  script:
    - find src -type f -name '*.php' -exec php -l {} \; | (! grep -v "No syntax errors detected" )

phpUnitReal:
  stage: test
  script:
    - export BLIZZARD_CLIENT_ID=$BLIZZARD_CLIENT_ID
    - export BLIZZARD_CLIENT_SECRET=$BLIZZARD_CLIENT_SECRET
    - php vendor/bin/phpunit --colors --configuration=phpunit-merge.xml
  only:
    - master
